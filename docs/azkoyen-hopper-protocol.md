# Azkoyen Hopper U-II Parallel Protocol Reference

**Source:** Azkoyen Parallel Protocol Manual (Version 1, 06-2011)
**Document:** `docs/hopper-protocol.pdf`

This document extracts the critical protocol specifications from the official Azkoyen manual.

---

## 1. Connector Pinout

The Azkoyen Hopper U-II uses a **10-pin (2x5) 2.5mm connector** (Molex 8624 series or similar).

### Standard Configuration (No Optional Sensors)

| Pin | Function |
|-----|----------|
| 1, 2, 3 | Vdc (12V power, all three pins connected together) |
| 4, 5, 6 | GND (ground, all pins connected together) |
| 7 | **Control** (motor activation signal) |
| 8 | **Error** (error reporting signal) |
| 9 | **Coin** (coin exit detection pulse) |

### With Empty Sensor (Optional)

| Pin | Function |
|-----|----------|
| 1, 2, 3 | Vdc |
| 4, 5, 6 | GND |
| 7 | Control |
| 8 | Error |
| 9 | Coin |
| **10** | **Empty sensor** (hopper coin bay empty detection) |

### With Full and Empty Sensors (Optional)

| Pin | Function |
|-----|----------|
| 1, 2, 3 | Vdc |
| 4, 5 | GND |
| **6** | **Full sensor** (hopper coin bay full detection) |
| 7 | Control |
| 8 | Error |
| 9 | Coin |
| 10 | Empty sensor |

---

## 2. Working Modes (DIP Switch Configuration)

The hopper has a **6-position DIP switch** (connector #6 on control board) that configures:
- **Logic polarity** (NEGATIVE vs POSITIVE)
- **Control mode** (Level-triggered vs Pulse-triggered)

### 2.1. NEGATIVE Logic Mode ⚠️ **REQUIRED FOR THIS PROJECT**

**Control signal (Pin 7):**
- **Motor ON:** Apply **0 logic** (< 0.5V) to pin 7
- **Motor OFF:** Apply **1 logic** (4V to Vcc ±10%) or disconnect

**Voltage thresholds:**
- LOW (motor ON): < 0.5V
- HIGH (motor OFF): 4V to Vcc ±10% (typically 4V to 13.2V for 12V supply)

**Motor activation:**
- Hopper starts motor when control pin goes LOW
- Motor controlled by H-bridge with MOSFET transistors

### 2.2. POSITIVE Logic Mode ❌ **NOT USED IN THIS PROJECT**

**Control signal (Pin 7):**
- **Motor ON:** Apply **1 logic** (4V to Vcc ±10%) to pin 7
- **Motor OFF:** Apply **0 logic** (0V to 0.25V)

**⚠️ WARNING:** This project requires NEGATIVE mode. POSITIVE mode will cause inverted motor behavior.

### 2.3. Control by Pulses Mode

**When pulse mode is used:**
- Extraction of coins is triggered by pulses on pin 7
- **Pulse characteristics:**
  - Positive logic pulses (signal at rest = low level)
  - Minimum duration: **5 milliseconds** (both HIGH and LOW level)
  - Validation occurs in ascending phase

**⚠️ NOTE:** This project uses **level-triggered NEGATIVE mode**, NOT pulse mode.

---

## 3. Protocol Signals

### 3.1. Control Signal (Pin 7)

**Purpose:** Activates/deactivates hopper motor for coin dispensing.

**Signal format:** Depends on DIP switch configuration (NEGATIVE, POSITIVE, or PULSES).

**For NEGATIVE mode (this project):**
- Set pin LOW (< 0.5V) to start motor
- Set pin HIGH (> 4V) or disconnect to stop motor

**Important timing:**
- Activation signal duration: Must be **> 5ms** to start motor
- Signal < 1ms to 5ms: Motor will NOT start

---

### 3.2. Coin Exit Signal (Pin 9) - PULSES Mode

**Purpose:** Hopper reports each dispensed coin via optical sensor pulse.

**Signal characteristics:**
- Generated by **open collector transistor**
- **At rest (no coin):** HIGH level
- **Coin detected:** Pulls LOW (0V)

**Pulse timing:**
- **Pulse duration:** 30-65 milliseconds LOW
- **Minimum:** 30ms
- **Maximum:** 65ms (if photocell continues detecting coin after 65ms, hopper generates Error 1)

**Pulse format:**
```
         HIGH (rest)
            │
            │   30-65ms LOW
            ▼   ◄─────►
    ────────┐         ┌────────
            │         │
            └─────────┘
            Coin detected
```

**Implementation notes:**
- One pulse = one coin dispensed
- Use FALLING edge interrupt to count coins
- Pulse width validation: 30-65ms range

---

### 3.3. Empty Signal (Pin 10) - Optional

**Purpose:** Indicates when hopper coin bay is empty.

**Signal characteristics:**
- Generated by **photocell** (photodiode + phototransistor) at bottom of coin bay
- Uses **open collector transistor** output

**Signal levels:**
- **Hopper NOT empty:** LOW (0V)
- **Hopper empty:** HIGH

**Physical location:** Bottom of coin bay

---

### 3.4. Full Signal (Pin 6) - Optional

**Purpose:** Indicates when hopper coin bay is full.

**Signal characteristics:**
- Generated by **photocell** (photodiode + phototransistor) at top of coin bay
- Uses **open collector transistor** output

**Signal levels:**
- **Hopper full:** LOW (0V)
- **Hopper NOT full:** HIGH

**Physical location:** Top of coin bay

---

### 3.5. Error Signal (Pin 8)

**Purpose:** Communicates hopper-detected errors to control system.

**Signal characteristics:**
- Generated by **open collector transistor**
- **At rest (no error):** HIGH level
- **Error active:** LOW (0V)

**Error signal format:**
1. Starts with **100ms pulse at 0V**
2. Followed by **10ms pulses** (T on/T off = 10ms/10ms)
3. Number of pulses = error code number
4. Repeats until new control order received to restart hopper

**Example (Error 4):**
```
ERROR (Pin 8):
        100ms
    ┌─────────┐  10ms pulses (4 times)
────┘         └─┐ ┐ ┐ ┐────────┐ ┐ ┐ ┐────...
                └┘└┘└┘└┘        └┘└┘└┘└┘
                   4 pulses    (repeats)

CONTROL (Pin 7):
    ┌──────────────────────────────────────
────┘                    └────────────────
                         Reset error
```

---

## 4. Error Codes

### 4.1. Error List

| Error | Description | Meaning | Consequence |
|-------|-------------|---------|-------------|
| **Error 1** | Coin permanently in exit sensor | Coin exit detected for > 65ms (maximum pulse time) | Stop hopper, error signal ON |
| **Error 2** | Coin exit sensor permanently at rest | Coin exit sensor stuck OFF | Stop hopper, error signal OFF |
| **Error 3** | Permanent jam detected | Hopper cannot free jam, maximum time exceeded | Stop hopper, error signal OFF |
| **Error 4** | Maximum span detected | Multiple spans detected > maximum time (3 spans max) | Stop hopper, error signal OFF |
| **Error 5** | Motor not detected | Motor doesn't start when voltage applied | Stop hopper, error signal OFF |
| **Error 6** | Fault in coin exit sensor | Coin exit connector disconnected or photodiode faulty | Stop hopper, error signal ON |
| **Error 7** | Power supply out of range | Power supply < minimum or > maximum rated voltage | Stop hopper, error signal OFF |

### 4.2. Error Signal Detection

**For systems monitoring error line:**
- Errors reported via pin 8 pulse code (see section 3.5)

**For systems NOT monitoring error line:**
- **Errors 1 and 6:** Reported via **coin signal line (pin 9) permanently active**
  - Exception: Error clears when jammed coin removed from opto sensor

---

## 5. DIP Switch Configuration Matrix

**Connector #6 on control board:**

```
┌──────────┬──────────┬──────────┬──────────┐
│          │ NEGATIVE │ POSITIVE │  PULSES  │
├──────────┼──────────┼──────────┼──────────┤
│ STANDARD │ ●  ●  ● │ ●    ●  │ ●  ●  ● │
│          │ ●  ●  ● │ ●  ●  ● │ ●  ●  ● │
├──────────┼──────────┼──────────┼──────────┤
│   PLUS   │ ●  ●    │ ●       │ ●  ●    │
│          │ ●  ●  ● │ ●  ●  ● │ ●    ● │
└──────────┴──────────┴──────────┴──────────┘

● = Switch ON (closed)
  = Switch OFF (open)
```

**⚠️ THIS PROJECT REQUIRES: STANDARD + NEGATIVE mode**

---

## 6. Electrical Specifications Summary

### Power Supply
- **Voltage:** 12V DC
- **Tolerance:** Per Error 7 detection (refer to hopper specs for exact range)
- **Pins:** 1, 2, 3 (all connected together internally)
- **Current:** ~2A peak (motor startup surge)

### Signal Levels (NEGATIVE Mode)

| Signal | Pin | Logic LOW | Logic HIGH | Type |
|--------|-----|-----------|------------|------|
| Control | 7 | < 0.5V (motor ON) | 4V to Vcc ±10% (motor OFF) | Input to hopper |
| Coin Exit | 9 | 0V (pulse active) | Open collector HIGH | Output from hopper |
| Error | 8 | 0V (error active) | Open collector HIGH | Output from hopper |
| Empty | 10 | 0V (NOT empty) | Open collector HIGH (empty) | Output from hopper |
| Full | 6 | 0V (full) | Open collector HIGH (NOT full) | Output from hopper |

### Output Characteristics
- All output signals use **open collector transistors**
- External pull-up resistors required on receiving side
- Maximum pull-up voltage: Vcc (12V)

---

## 7. Timing Specifications

| Parameter | Value | Notes |
|-----------|-------|-------|
| **Control pulse minimum** | 5ms | Signals < 5ms won't start motor |
| **Coin pulse duration** | 30-65ms | Fixed pulse per coin in PULSES mode |
| **Coin pulse minimum** | 30ms | Minimum valid pulse |
| **Coin pulse maximum** | 65ms | Exceeding triggers Error 1 |
| **Error pulse width** | 10ms | For error code transmission |
| **Error start pulse** | 100ms | First pulse of error sequence |

---

## 8. Implementation Notes for This Project

### 8.1. Required Configuration

**DIP switch settings (connector #6):**
- ✅ **NEGATIVE mode** (active LOW control)
- ✅ **STANDARD mode** (not PLUS)
- ✅ **NOT PULSES mode** (level-triggered control)

**Setting:** STANDARD + NEGATIVE (see matrix in section 5)

### 8.2. Control Pin (7) Usage

**With optocoupler isolation (PC817):**
- Optocoupler output (collector) → Hopper pin 7
- Optocoupler emitter → Hopper GND
- Pull-up resistor on optocoupler output (if not on module)

**Expected behavior:**
- GPIO HIGH → Optocoupler ON → Pin 7 pulled LOW → Motor ON
- GPIO LOW → Optocoupler OFF → Pin 7 HIGH (via pull-up) → Motor OFF

**Critical voltage levels:**
- Motor ON: Pin 7 must be < 0.5V
- Motor OFF: Pin 7 must be > 4V (ideally 10-12V with 12V supply)

### 8.3. Coin Pulse Detection (Pin 9)

**Interrupt configuration:**
- Use FALLING edge interrupt (HIGH → LOW transition)
- Expected pulse width: 30ms (validate if needed)
- One pulse = one coin dispensed

**With optocoupler (PC817):**
- Hopper pin 9 → Optocoupler input (via current-limiting resistor)
- Optocoupler output → ESP8266 GPIO (with pull-up)
- Signal will be inverted: pulse appears as LOW on GPIO

### 8.4. Error Detection (Pin 8)

**Monitoring strategy:**
- Read pin state to detect error condition (LOW = error)
- Count pulses to identify error code (if needed)
- Most common errors: Error 3 (jam), Error 1 (coin stuck)

**Simplified approach (used in this project):**
- Monitor for any LOW on pin 8 = error condition
- Don't decode error number (assume jam/fault)
- Require power cycle or manual reset to clear

---

## 9. Protocol vs. This Project's Implementation

### What We Use

| Hopper Feature | This Project |
|----------------|--------------|
| **Control mode** | NEGATIVE logic (level-triggered) |
| **Control signal** | Via PC817 optocoupler, active LOW |
| **Coin detection** | Pin 9 pulses (PULSES coin mode, not control mode) |
| **Error detection** | Pin 8 monitoring (simplified, no pulse counting) |
| **Empty sensor** | Pin 10 (optional, can be monitored) |
| **Full sensor** | Not used |

### What We DON'T Use

- POSITIVE logic mode
- PULSES control mode (control by pulses on pin 7)
- Error code decoding (pulse counting on pin 8)
- Full sensor (pin 6)

---

## 10. Critical Warnings

### ⚠️ DIP Switch MUST Be Set to NEGATIVE Mode

**Symptom of wrong mode:**
- Motor engages when it shouldn't (e.g., after timeout)
- Motor doesn't engage when expected (during dispense)
- Completely inverted behavior

**Fix:**
1. Power off hopper
2. Open hopper (4 screws)
3. Locate DIP switch connector #6
4. Set to STANDARD + NEGATIVE configuration
5. Close and test

### ⚠️ Voltage Levels Matter

**Pin 7 (Control) in NEGATIVE mode:**
- **< 0.5V** = Motor ON (reliable threshold)
- **> 4V** = Motor OFF (minimum threshold)
- **Between 0.5V and 4V** = Undefined behavior!

With PC817 optocoupler and 10kΩ pull-up + hopper input impedance:
- Typical HIGH = ~6V (acceptable for motor OFF)
- Typical LOW = < 0.5V (good for motor ON)

**If motor behavior is unreliable, check these voltages first!**

### ⚠️ Pulse Width Validation

Coin pulses are 30-65ms. If implementing pulse width checking:
- Accept pulses 30-65ms
- Reject pulses < 30ms (noise)
- Reject pulses > 65ms (hopper will generate Error 1)

This project uses simple edge counting without validation.

---

## References

- **Official Manual:** `docs/hopper-protocol.pdf`
- **Azkoyen Website:** www.azkoyen.com
- **Manual Version:** 1, dated 06-2011

---

**Last Updated:** 2026-02-13
**Extracted By:** Claude Code documentation task
